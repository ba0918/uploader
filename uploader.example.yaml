# uploader 設定ファイルサンプル
# このファイルを uploader.yaml にコピーして使用してください

_global:
  ignore: # 除外パターン（glob形式）
    - "*.log"
    - ".git/"
    - ".claude/"
    - "node_modules/"

# ===========================================
# プロファイル: development（gitモード）
# ===========================================
development:
  from:
    type: "git"
    base: "origin/main" # 比較元ブランチ（CLI: --base で上書き可能）
    target: "HEAD" # 比較先（CLI: --target で上書き可能）
    include_untracked: false # 未追跡ファイルを含むか

  to:
    targets:
      - host: "web1.example.com"
        protocol: "sftp" # sftp / scp / rsync / local
        port: 22
        user: "${DEPLOY_USER}"
        auth_type: "ssh_key"
        key_file: "~/.ssh/id_rsa"
        dest: "/var/www/html/"
        sync_mode: "update" # update: 追加・更新のみ / mirror: 完全同期
        preserve_permissions: true
        preserve_timestamps: true
        timeout: 30 # 秒
        retry: 3

# ===========================================
# プロファイル: staging（fileモード）
# ===========================================
staging:
  from:
    type: "file"
    src: # アップロード対象（複数指定可、glob対応）
      - "dist/" # ディレクトリ（末尾/で中身のみ）
      - "public/assets/"

  to:
    targets:
      - host: "staging.example.com"
        protocol: "sftp"
        port: 22
        user: "deployer"
        auth_type: "ssh_key"
        key_file: "~/.ssh/deploy_key"
        dest: "/var/www/staging/"
        sync_mode: "update"
        timeout: 30
        retry: 3

# ===========================================
# プロファイル: production（defaults使用、複数ターゲット）
# ===========================================
production:
  from:
    type: "git"
    base: "origin/main"

  to:
    # defaults: 全ターゲット共通の設定
    defaults:
      protocol: "rsync"
      port: 22
      user: "${DEPLOY_USER}"
      auth_type: "ssh_key"
      key_file: "~/.ssh/deploy_key"
      sync_mode: "mirror"
      timeout: 60
      retry: 3
      rsync_path: "sudo rsync" # リモートでsudo実行
      rsync_options: # rsync追加オプション
        - "--chmod=D755,F644"
        - "--chown=www-data:www-data"

    targets:
      # 各ターゲットはdestのみ必須、他はdefaultsから継承
      - host: "web1.example.com"
        dest: "/var/www/html/"
      - host: "web2.example.com"
        dest: "/var/www/html/"
      - host: "web3.example.com"
        dest: "/var/www/html/"
        timeout: 120 # 個別設定でdefaultsを上書き可能

# ===========================================
# プロファイル: legacy（古いSSHサーバー向け）
# ===========================================
legacy:
  from:
    type: "file"
    src:
      - "dist/"

  to:
    targets:
      - host: "old-server.example.com"
        protocol: "scp"
        port: 22
        user: "admin"
        auth_type: "password"
        password: "${LEGACY_PASSWORD}" # 環境変数推奨
        dest: "/home/admin/public_html/"
        legacy_mode: true # 古いSSHアルゴリズムを有効化

# ===========================================
# プロファイル: local（ローカルコピー）
# ===========================================
local:
  from:
    type: "file"
    src:
      - "dist/"

  to:
    targets:
      - host: "localhost"
        protocol: "local" # ローカルファイルコピー
        dest: "/tmp/deploy-test/"
        sync_mode: "mirror"

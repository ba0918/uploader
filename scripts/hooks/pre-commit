#!/bin/bash
#
# Pre-commit hook for uploader project
# „Åì„ÅÆ„Éï„ÉÉ„ÇØ„ÅØ‰ª•‰∏ã„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÆüË°å„Åó„Åæ„Åô:
#   1. Âûã„ÉÅ„Çß„ÉÉ„ÇØ (deno check)
#   2. Lint„ÉÅ„Çß„ÉÉ„ÇØ (deno lint)
#   3. „Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÉÅ„Çß„ÉÉ„ÇØ (deno fmt --check)
#   4. „ÉÜ„Çπ„ÉàÂÆüË°å (deno task test)
#
# „Ç§„É≥„Çπ„Éà„Éº„É´ÊñπÊ≥ï:
#   deno task install-hooks
#
# ‰∏ÄÊôÇÁöÑ„Å´„Çπ„Ç≠„ÉÉ„Éó„Åô„ÇãÊñπÊ≥ï:
#   git commit --no-verify
#

set -e

echo "üîç Running pre-commit checks..."
echo ""

# Ëâ≤„ÅÆÂÆöÁæ©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 1. Âûã„ÉÅ„Çß„ÉÉ„ÇØ
echo "üìù Type checking..."
if ! deno check main.ts > /dev/null 2>&1; then
    echo -e "${RED}‚ùå Type check failed!${NC}"
    echo "Fix type errors before committing."
    echo "Run 'deno check main.ts' to see errors."
    exit 1
fi
echo -e "${GREEN}‚úì Type check passed${NC}"
echo ""

# 2. Lint„ÉÅ„Çß„ÉÉ„ÇØ
echo "üîé Running lint..."
if ! deno lint --quiet; then
    echo -e "${RED}‚ùå Lint check failed!${NC}"
    echo "Run 'deno lint' to see errors and fix them."
    exit 1
fi
echo -e "${GREEN}‚úì Lint check passed${NC}"
echo ""

# 3. „Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÉÅ„Çß„ÉÉ„ÇØ
echo "üíÖ Checking code format..."
if ! deno fmt --check --quiet; then
    echo -e "${YELLOW}‚ö†Ô∏è  Code formatting issues found${NC}"
    echo "Run 'deno fmt' to fix formatting."
    echo ""
    read -p "Do you want to auto-format and continue? (y/N) " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        deno fmt
        echo -e "${GREEN}‚úì Code formatted${NC}"
    else
        echo -e "${RED}‚ùå Commit aborted${NC}"
        exit 1
    fi
else
    echo -e "${GREEN}‚úì Code format check passed${NC}"
fi
echo ""

# 4. „ÉÜ„Çπ„ÉàÂÆüË°å
echo "üß™ Running tests..."
if ! deno task test --quiet 2>&1 | tail -5; then
    echo -e "${RED}‚ùå Tests failed!${NC}"
    echo "Fix failing tests before committing."
    exit 1
fi
echo -e "${GREEN}‚úì All tests passed${NC}"
echo ""

echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
echo "Proceeding with commit..."

#!/bin/bash
#
# Pre-push hook for uploader project
# „Åì„ÅÆ„Éï„ÉÉ„ÇØ„ÅØpushÂâç„Å´‰ª•‰∏ã„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÆüË°å„Åó„Åæ„Åô:
#   1. Âûã„ÉÅ„Çß„ÉÉ„ÇØ (deno check)
#   2. Lint„ÉÅ„Çß„ÉÉ„ÇØ (deno lint)
#   3. ÂÖ®„ÉÜ„Çπ„ÉàÂÆüË°å (deno task test)
#
# „Ç§„É≥„Çπ„Éà„Éº„É´ÊñπÊ≥ï:
#   deno task install-hooks
#
# ‰∏ÄÊôÇÁöÑ„Å´„Çπ„Ç≠„ÉÉ„Éó„Åô„ÇãÊñπÊ≥ï:
#   git push --no-verify
#

set -e

echo "üöÄ Running pre-push checks..."
echo ""

# Ëâ≤„ÅÆÂÆöÁæ©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# pushÂØæË±°„ÅÆ„Éñ„É©„É≥„ÉÅÊÉÖÂ†±„ÇíÂèñÂæó
remote="$1"
url="$2"

echo -e "${BLUE}‚ÑπÔ∏è  Pushing to: ${remote} (${url})${NC}"
echo ""

# 1. Âûã„ÉÅ„Çß„ÉÉ„ÇØ
echo "üìù Type checking..."
if ! deno check main.ts > /dev/null 2>&1; then
    echo -e "${RED}‚ùå Type check failed!${NC}"
    echo "Fix type errors before pushing."
    echo "Run 'deno check main.ts' to see errors."
    exit 1
fi
echo -e "${GREEN}‚úì Type check passed${NC}"
echo ""

# 2. Lint„ÉÅ„Çß„ÉÉ„ÇØ
echo "üîé Running lint..."
if ! deno lint --quiet; then
    echo -e "${RED}‚ùå Lint check failed!${NC}"
    echo "Run 'deno lint' to see errors and fix them."
    exit 1
fi
echo -e "${GREEN}‚úì Lint check passed${NC}"
echo ""

# 3. ÂÖ®„ÉÜ„Çπ„ÉàÂÆüË°å
echo "üß™ Running all tests..."
echo "This may take a few minutes..."
if ! deno task test --quiet 2>&1 | tail -5; then
    echo ""
    echo -e "${RED}‚ùå Tests failed!${NC}"
    echo "Fix failing tests before pushing."
    echo "Run 'deno task test' to see details."
    exit 1
fi
echo -e "${GREEN}‚úì All tests passed${NC}"
echo ""

echo -e "${GREEN}‚úÖ All pre-push checks passed!${NC}"
echo "Proceeding with push..."
